<<<<<<< HEAD
package com.team2.dash;

import java.util.ArrayList;
import java.util.List;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.location.Criteria;
import android.location.Location;
import android.location.LocationListener;
import android.location.LocationManager;
import android.os.Bundle;
import android.provider.Settings;
import android.app.AlertDialog;
import android.app.ListActivity;
import android.content.DialogInterface;
import android.content.Intent;
import android.util.Log;
import android.view.Menu;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.Toast;

import com.team2.dash.entity.*;

/*
 * Class to handle the display of checkin locations. Displays Locations in a clickable list.
 */
public class CheckIn extends ListActivity implements LocationListener
{

	private LocationManager locationManager = null;	
	private List<VenueInfo> VenueInformation;
	private Double latitude, longitude;
	private JSONObject results;
	private String provider;
	private String[][] vars;		
	private ArrayList<String> listItems = new ArrayList<String>();
	
    @Override
    public void onCreate(Bundle savedInstanceState) 
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_check_in);
        //CheckForGPSEnabled();
        //runOnUiThread(UpdateGPSOnUI);
        //retrieve json data from RouteMap after checkin has been clicked.
        Bundle bundle = getIntent().getExtras();
        String venueJson = bundle.getString("locationJson");
        results = ServerConnector.ConvertStringToObject(venueJson);
        RefreshVenueInfo();  
        
       	ArrayAdapter<VenueInfo> adapter = new ArrayAdapter<VenueInfo>(this, android.R.layout.simple_list_item_1,VenueInformation);
       	      	
        setListAdapter(adapter);
        
        ListView lv = getListView();
        lv.setOnItemLongClickListener(
        	new AdapterView.OnItemLongClickListener() {
        		public boolean onItemLongClick(AdapterView<?> adapter, View view, int position, long id) {
        			return onLongListItemClick(view, position, id) ;
        		}
        	}
        );          
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) 
    {
        getMenuInflater().inflate(R.menu.activity_check_in, menu);
        return true;
    }
    
    public void onProviderEnabled(String provider) 
    {
      Toast.makeText(this, "Enabled new provider " + provider, Toast.LENGTH_SHORT).show();
    }

    public void onProviderDisabled(String provider) 
    {
      Toast.makeText(this, "Disabled provider " + provider, Toast.LENGTH_SHORT).show();
    }

	public void onStatusChanged(String provider, int status, Bundle extras) 
	{
		// TODO Auto-generated method stub		
	}
	
    @Override
    public void onResume() 
    {
        super.onResume();
       	//CheckForGPSEnabled();
        //locationManager.requestLocationUpdates(provider, 400, 1, this);            
    }

    @Override
    protected void onPause() 
    {
      super.onPause();
      //locationManager.removeUpdates(this);
    }
    
    public void onLocationChanged(Location location) 
    {
//    	latitude = location.getLatitude();
//    	longitude = location.getLongitude();
//    	Log.v("Latitude", "" + latitude);
//    	Log.v("Longitude", "" + longitude);
    }     
    
    public void onRefreshClick(View view)
    {
        CheckForGPSEnabled();
        runOnUiThread(UpdateGPSOnUI);
        RefreshVenueInfo();     
    }
    
    private void UpdateGPS()
    {    	    	    
    	Criteria hdCrit = new Criteria();
    	hdCrit.setAccuracy(Criteria.ACCURACY_FINE);
        provider = locationManager.getBestProvider(hdCrit, false);
        Location location = locationManager.getLastKnownLocation(provider);
        if (location != null) 
        {
          Log.v("GPS", "Provider " + provider + " has been selected.");
          onLocationChanged(location);
        } 
        else 
        {
	    	Log.v("Latitude", "Location not available");
	    	Log.v("Longitude", "Location not available");        	
        }
    	
    }        
        
    private void CheckForGPSEnabled()
    {    	
    	locationManager = (LocationManager) getSystemService(LOCATION_SERVICE);    	
        boolean enabled = false;
        try
        {        	
        	enabled = locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER);
        	//enabled = locationManager.isProviderEnabled(LocationManager.NETWORK_PROVIDER);        	
        }
        catch (Exception e)
        {
        	Log.e("Class", "Here!");
			AlertDialog alertDialog = new AlertDialog.Builder(this).create();
			alertDialog.setTitle("Error");
			alertDialog.setMessage("Error with GPS Location.\n" + e.getMessage());
			alertDialog.setButton(DialogInterface.BUTTON_POSITIVE, "OK", new DialogInterface.OnClickListener() 
			{
				public void onClick(DialogInterface dialog, int arg1) 
				{
					dialog.cancel();
					return;
	            }
			});						
			alertDialog.show();
        }

		// Check if enabled and if not send user to the GSP settings
		// Better solution would be to display a dialog and suggesting to 
		// go to the settings
		if (enabled == false) {
			AlertDialog alertDialog = new AlertDialog.Builder(this).create();
			alertDialog.setTitle("GPS Disabled");
			alertDialog.setMessage("Location services are currently disabled\nGo to Settings to activate them.");
			alertDialog.setButton(DialogInterface.BUTTON_POSITIVE, "Location Services", new DialogInterface.OnClickListener() 
			{
				public void onClick(DialogInterface dialog, int arg1) 
				{
					Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);
					startActivity(intent);
	            }
			});						
			alertDialog.show();
		} 
    }
        
    private final Runnable UpdateGPSOnUI = new Runnable() 
    {        
    	public void run() 
    	{
    		UpdateGPS();
        }
    };            
    
    public void RefreshVenueInfo()
    {    	
    	//TODO: Considering if location should be fetched here again or location data should be passed form RouteMap
//    	if(latitude == null || longitude == null)
//    	{
//    		Toast.makeText(this, "There are currently no GPS Results", Toast.LENGTH_SHORT).show();
//    		return;
//    	}
    	
    	try
    	{    		
//    		vars = new String[2][2];
//    		vars[0][0] = "latitude";
//    		vars[0][1] = latitude.toString();
//    		vars[1][0] = "longitude";
//    		vars[1][1] = longitude.toString();
//    		
    		//AsyncChanges
    		//runOnUiThread(SendAndRecieveFourSquareResponse); 
    		
    		if (results == null)
	    	{
	    		Toast.makeText(this, "Unable to pull back location results", Toast.LENGTH_SHORT).show();
	    	} 
	    	else 
	    	{
	    		JSONArray venues = results.getJSONArray("venues");
	    		VenueInformation = new ArrayList<VenueInfo>();
	    		for(int i = 0; i < venues.length(); i++)
	    		{
	    			VenueInfo singleVenue = new VenueInfo();
	    			JSONObject singleJSONVenue = venues.getJSONObject(i);
	    			singleVenue.setId(singleJSONVenue.getString("id"));
	    			singleVenue.setLatitude(singleJSONVenue.getDouble("lat"));
	    			singleVenue.setLongitude(singleJSONVenue.getDouble("lng"));
	    			singleVenue.setVenueAddress(singleJSONVenue.getString("address"));
	    			singleVenue.setVenueName(singleJSONVenue.getString("name"));
	    			VenueInformation.add(singleVenue);
	    			listItems.add(VenueInformation.toString());
	    		}
	    		Log.v("Information", "" + VenueInformation.size());  		
	    	}
    	}      	
	    catch (JSONException e)
	    {
	    	Toast.makeText(this, "Unable to pull back location results", Toast.LENGTH_SHORT).show();
			Log.v("Error", "JSONException " + e.getMessage());    			
			return;
	    }    	  
    } 
    
    @Override
    public void onListItemClick( ListView l, View v, int position, long id) {
    	VenueInfo venue = (VenueInfo)l.getItemAtPosition(position);
    	//db.setUserActive(user.getID());
    	String txt = "Venue " + venue.toString() + " selected";
    	Toast.makeText(this, txt, Toast.LENGTH_SHORT).show();
    	//finish();
    }  

    public boolean onLongListItemClick(View v, int position, long id) {
    	ListView l = getListView();
    	VenueInfo venue = (VenueInfo)l.getItemAtPosition(position);    	
    	refreshList();
    	String txt = "Venue " + venue.toString() + " deleted";
    	Toast.makeText(this, txt, Toast.LENGTH_SHORT).show();
    	
    	return true;
    }
    
    private void refreshList(){
        @SuppressWarnings("unchecked")      
        ArrayAdapter<VenueInfo> adapter = (ArrayAdapter<VenueInfo>) getListAdapter();
        RefreshVenueInfo();
        adapter.clear();        
        for(int i = 0; i < VenueInformation.size(); i++) {
        	adapter.add(VenueInformation.get(i));
        }
        
        adapter.notifyDataSetChanged();   	
    }      
    
    private final Runnable SendAndRecieveFourSquareResponse = new Runnable() 
    {        
    	public void run() 
    	{
    		ServerConnector sc = new ServerConnector(vars, "Test.php", false);
    		results = sc.ConvertStringToObject(null); 
        }
    };

}
=======
package com.team2.dash;

import java.util.ArrayList;
import java.util.List;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.os.Bundle;
import android.app.ListActivity;
import android.content.Intent;
import android.util.Log;
import android.view.Menu;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.Toast;

import com.team2.dash.entity.*;

/*
 * Class to handle the display of checkin locations. Displays Locations in a clickable list.
 */
public class CheckIn extends ListActivity
{

	private List<VenueInfo> VenueInformation;	
	private JSONObject results;	
	private ArrayList<String> listItems = new ArrayList<String>();
	//private VenueInfo testVenue;
	
    @Override
    public void onCreate(Bundle savedInstanceState) 
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_check_in);
        Bundle bundle = getIntent().getExtras();
        String venueJson = bundle.getString("locationJson");
    	results = ServerConnector.ConvertStringToObject(venueJson);    	
        RefreshVenueInfo();  
        
       	ArrayAdapter<VenueInfo> adapter = new ArrayAdapter<VenueInfo>(this, android.R.layout.simple_list_item_1,VenueInformation);
       	      	
        setListAdapter(adapter);
        
        //Test data
//        testVenue = new VenueInfo();
//        testVenue.setFourSquareId("4c039b9af56c2d7fa3121d66");
//        testVenue.setVenueName("East Slope Bar");
//        testVenue.setVenueAddress("University of Sussex");
//        testVenue.setLatitude(50.869373);
//        testVenue.setLongitude(-0.088239);

    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) 
    {
        getMenuInflater().inflate(R.menu.activity_check_in, menu);
        return true;
    }

    public void RefreshVenueInfo()
    {    	    	
    	try
    	{    		
    		if (results == null)
	    	{
	    		Toast.makeText(this, "Unable to pull back location results", Toast.LENGTH_SHORT).show();
	    	} 
	    	else 
	    	{
	    		JSONArray venues = results.getJSONArray("venues");
	    		VenueInformation = new ArrayList<VenueInfo>();
	    		for(int i = 0; i < venues.length(); i++)
	    		{
	    			VenueInfo singleVenue = new VenueInfo();
	    			JSONObject singleJSONVenue = venues.getJSONObject(i);
	    			singleVenue.setFourSquareCheckins(singleJSONVenue.getInt("nbrCheckins"));
	    			singleVenue.setFourSquareId(singleJSONVenue.getString("id"));
	    			singleVenue.setLatitude(singleJSONVenue.getDouble("lat"));
	    			singleVenue.setLongitude(singleJSONVenue.getDouble("lng"));
	    			singleVenue.setVenueAddress(singleJSONVenue.getString("address"));
	    			singleVenue.setVenueName(singleJSONVenue.getString("name"));
	    			VenueInformation.add(singleVenue);
	    			listItems.add(VenueInformation.toString());
	    		}
	    	}
    	}      	
	    catch (JSONException e)
	    {
	    	Toast.makeText(this, "Unable to pull back location results", Toast.LENGTH_SHORT).show();
			Log.v("Error", "JSONException " + e.getMessage());    			
			return;
	    }    	  
    } 
    
    @Override
    public void onListItemClick( ListView l, View v, int position, long id) 
    {
    	VenueInfo venue = (VenueInfo)l.getItemAtPosition(position);
    	//VenueInfo venue = testVenue;    	
    	Toast.makeText(this, "Checking In at " + venue.toString(), Toast.LENGTH_SHORT).show();
    	
    	String[][] vars = new String[4][2];
    	vars[0][0] = "n";
    	vars[0][1] = venue.VenueName;
    	vars[1][0] = "d";
    	vars[1][1] = venue.VenueAddress;
    	vars[2][0] = "f";
    	vars[2][1] = venue.FourSquareId;
    	vars[3][0] = "a";
    	vars[3][1] = "addLocation";    	    	
    	
    	ServerConnector sc = new ServerConnector(vars, false, CheckIn.this, "Contacting Dash Server ...");    	
    	String response;
    	try
    	{
    		response = sc.execute(new String[] { "AddLocation.php"}).get();    	
    	} 
    	catch (Exception e)
    	{
			Log.v("Error", "CheckIn Exception " + e.getMessage());   
			return;
    	}
    	
    	try 
    	{   

    		JSONObject singleVenue = ServerConnector.ConvertStringToObject(response);
			
			if (singleVenue.getString("success") == "true")
			{
				int result_http = singleVenue.getInt("result");
				if(result_http > 0)
				{
					Toast.makeText(this, "Result: " + result_http, Toast.LENGTH_SHORT).show();
					//TODO: Check user in to location					
					
			    	Intent intent = new Intent(this,CheckIn.class);
					intent.putExtra("fourSquareId", venue.FourSquareId);
					intent.putExtra("dashId", result_http);
					startActivity(intent);  					
				} 
				else if (result_http == -1)
				{
					Log.e("HTTP Result", "Location was not registered due to DB problem");					
				}
				else if (result_http == -2)
				{					
					Log.e("HTTP Result", "Four Square ID is already in use by other location (ID: " + venue.FourSquareId +")");					
				}
			} 
			else 
			{
				Log.e("HTTP Result", "Incorrect Page Call");
			}	
			Toast.makeText(this, "Failed to Check In", Toast.LENGTH_SHORT).show();
		}     
	    catch(JSONException e)
	    {
			e.printStackTrace(); 
			Log.v("Error", "CheckIn Exception " + e.getMessage());   
			return;
	    }	  
    }      
}
>>>>>>> e0d4b8c01ef69b43f0957b817a00ac99e0c513c7
